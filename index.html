<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <title>Харе Кришна</title>

        <!-- ШРИФТЫ -->
        <link
            href="https://fonts.googleapis.com/css2?family=Bad+Script&family=Great+Vibes&display=swap"
            rel="stylesheet"
        />

        <!-- СВЕТЛАЯ ТЕМА ПО УМОЛЧАНИЮ -->
        <link id="themeStylesheet" rel="stylesheet" href="style2.css" />

        <style>
            /* ─── ДОБАВКИ ─── */

            /* отменяем старый word-spacing и даём отступ через margin */
            .centered {
                word-spacing: 0;
            }
            .waviy span + span {
                margin-left: 30px;
            }
        </style>
    </head>
    <body>
        <!-- СЧЁТЧИК -->
        <div class="counter" id="counter">Круги: 1 | Бусины: 1</div>

        <!-- СЕЛЕКТОР ЯЗЫКА -->
        <select
            id="langSel"
            class="icon-btn"
            style="position: fixed; left: 10px; top: 10px; z-index: 20"
        >
            <option value="ru">🇷🇺 Ru</option>
            <option value="en">🇬🇧 En</option>
            <option value="pl">🇵🇱 Pl</option>
            <option value="de">🇩🇪 De</option>
            <option value="uk">🇺🇦 Uk</option>
            <option value="cs">🇨🇿 Cs</option>
            <option value="be">🇧🇾 Be</option>
            <option value="tr">🇹🇷 Tr</option>
            <option value="el">🇬🇷 El</option>
            <option value="ka">🇬🇪 Ka</option>
            <option value="he">🇮🇱 He</option>
            <option value="yi">🕍 Yi</option>
            <option value="ja">🇯🇵 Ja</option>
            <option value="ko">🇰🇷 Ko</option>
        </select>

        <!-- ПРИВЕТСТВИЕ -->
        <div id="intro" class="intro">
            <span>(джайа) Шри-Кришна-Чайтания</span>
            <span>Прабху Нитьянанда</span>
            <span>Шри-Адвайта Гададхара</span>
            <span>Шривасади-Гаура-Бхакта-Вринда</span>
        </div>

        <!-- КНОПКИ ± ШРИФТА -->
        <div class="font-ctrl" id="fontCtrl">
            <button id="fInc" class="f-btn">+</button>
            <button id="fDec" class="f-btn">−</button>
        </div>

        <!-- ПАНЕЛЬ СКОРОСТИ / ТЕМЫ -->
        <div class="controls">
            <button id="dec" class="spd-btn">−</button>
            <span id="spdText" class="spd-text">5с</span>
            <button id="inc" class="spd-btn">+</button>

            <!-- ТЕМА -->
            <button id="theme" class="icon-btn" aria-label="Сменить тему">
                <svg
                    id="moon"
                    viewBox="0 0 24 24"
                    width="24"
                    height="24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
                <svg
                    id="sun"
                    class="hidden"
                    viewBox="0 0 24 24"
                    width="24"
                    height="24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <circle cx="12" cy="12" r="5" />
                    <line x1="12" y1="1" x2="12" y2="3" />
                    <line x1="12" y1="21" x2="12" y2="23" />
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                    <line x1="1" y1="12" x2="3" y2="12" />
                    <line x1="21" y1="12" x2="23" y2="12" />
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                </svg>
            </button>
        </div>

        <!-- МАНТРА -->
        <div class="centered"><div class="waviy" id="waviy"></div></div>

        <!-- === БАЗОВЫЙ JS === -->
        <script>
            /* СЧЁТЧИК */
            let beads = 1,
                rounds = 1,
                introVisible = true;
            const waviy = document.getElementById("waviy");
            const out = document.getElementById("counter");
            const intro = document.getElementById("intro");
            function updateCounter() {
                out.textContent = `Круги: ${rounds} | Бусины: ${beads}`;
                console.log(
                    `Counter updated: Rounds=${rounds}, Beads=${beads}`,
                );
            }

            function onIter() {
                if (introVisible) {
                    console.log(
                        "Ignoring animation iteration due to intro visible",
                    );
                    return;
                }
                if (++beads > 108) {
                    beads = 1;
                    ++rounds;
                    showIntro();
                }
                updateCounter();
            }

            function attachFirstListener() {
                waviy
                    .querySelectorAll("#first")
                    .forEach((el) => el.removeAttribute("id"));
                const first = waviy.querySelector("span");
                if (!first) {
                    console.log("No first span found, retrying after 100ms");
                    setTimeout(attachFirstListener, 100);
                    return;
                }
                first.id = "first";
                first.addEventListener("animationiteration", onIter);
                console.log("Animation listener attached to first span");
            }

            function showIntro() {
                clearTimeout(showIntro.t);
                introVisible = true;
                intro.classList.remove("hidden");
                waviy.classList.add("paused");
                showIntro.t = setTimeout(() => {
                    intro.classList.add("hidden");
                    waviy.classList.remove("paused");
                    introVisible = false;
                    restartWave();
                    updateCounter();
                    console.log("Intro hidden, animation restarted");
                }, 10000);
            }

            /* СКОРОСТЬ */
            let speed = 6.0;
            const min = 4,
                max = 9,
                step = 0.5;
            const spdText = document.getElementById("spdText");

            function setSpeed(restart) {
                document.documentElement.style.setProperty(
                    "--speed",
                    speed + "s",
                );
                document.documentElement.style.setProperty(
                    "--step",
                    (speed / 16).toFixed(3) + "s",
                );
                spdText.textContent = speed.toFixed(1) + "с";
                if (restart) {
                    restartWave();
                    console.log("Speed set, animation restarted");
                }
            }

            function restartWave() {
                const spans = waviy.querySelectorAll("span");
                spans.forEach((s) => {
                    s.style.animation = "none";
                    s.offsetHeight; // триггер рефлоу
                    s.style.animation = "waviy var(--speed) infinite";
                    s.style.animationDelay = `calc(var(--step) * ${s.style.getPropertyValue("--i")})`;
                });
                attachFirstListener();
                console.log("Wave animation reset for", spans.length, "spans");
            }

            function changeSpeed(delta) {
                const next = +(speed + delta).toFixed(1);
                if (next >= min && next <= max) {
                    speed = next;
                    setSpeed(true);
                }
            }

            document.getElementById("inc").onclick = () => changeSpeed(+step);
            document.getElementById("dec").onclick = () => changeSpeed(-step);

            /* ТЕМА */
            document.getElementById("theme").onclick = () => {
                const link = document.getElementById("themeStylesheet");
                const lightNow = link.href.endsWith("style2.css");
                link.href = lightNow ? "style.css" : "style2.css";
                document
                    .getElementById("sun")
                    .classList.toggle("hidden", !lightNow);
                document
                    .getElementById("moon")
                    .classList.toggle("hidden", lightNow);
                console.log("Theme switched to", lightNow ? "dark" : "light");
                restartWave();
            };

            /* ШРИФТ */
            let baseSize = 70,
                fStep = 5;
            const fontCtrl = document.getElementById("fontCtrl");
            document.getElementById("fInc").onclick = () => {
                baseSize += fStep;
                waviy.style.fontSize = baseSize + "px";
                showCtrl();
                console.log("Font size increased to", baseSize);
            };
            document.getElementById("fDec").onclick = () => {
                if (baseSize > 30) {
                    baseSize -= fStep;
                    waviy.style.fontSize = baseSize + "px";
                    showCtrl();
                    console.log("Font size decreased to", baseSize);
                }
            };

            function showCtrl() {
                if (window.innerWidth < 1024) {
                    console.log("Font controls not shown on mobile (<1024px)");
                    return;
                }
                clearTimeout(hideTimer);
                fontCtrl.classList.add("active");
                hideTimer = setTimeout(() => {
                    fontCtrl.classList.remove("active");
                    console.log("Font controls hidden");
                }, 4000);
            }

            document.addEventListener("mousemove", (e) => {
                if (window.innerWidth < 1024) return;
                if (
                    e.clientX > window.innerWidth - 250 &&
                    e.clientY > window.innerHeight - 250
                ) {
                    console.log(
                        `Mouse at: x=${e.clientX}, y=${e.clientY}, window: ${window.innerWidth}x${window.innerHeight}`,
                    );
                    showCtrl();
                }
            });

            fontCtrl.addEventListener("mouseenter", () => {
                if (window.innerWidth < 1024) return;
                clearTimeout(hideTimer);
                fontCtrl.classList.add("active");
                console.log("Mouse entered font controls");
            });
            fontCtrl.addEventListener("mouseleave", () => {
                if (window.innerWidth < 1024) return;
                hideTimer = setTimeout(() => {
                    fontCtrl.classList.remove("active");
                    console.log("Font controls hidden after mouse leave");
                }, 4000);
            });

            // Показываем кнопки на 3 секунды при загрузке
            if (window.innerWidth >= 1024) {
                fontCtrl.classList.add("active");
                setTimeout(() => fontCtrl.classList.remove("active"), 3000);
                console.log("Font controls shown on load");
            }

            // Fallback для проверки анимации
            setInterval(() => {
                const first = waviy.querySelector("#first");
                if (!first) {
                    console.log("No first span, reattaching listener");
                    attachFirstListener();
                    return;
                }
                const computedStyle = getComputedStyle(first);
                if (
                    computedStyle.animationPlayState === "paused" &&
                    !introVisible
                ) {
                    console.log("Animation paused unexpectedly, restarting...");
                    restartWave();
                }
            }, 5000);

            /* НАЧАЛЬНАЯ УСТАНОВКА */
            setSpeed(false);
            showIntro();
        </script>

        <!-- === ЗАГРУЗКА JSON И СМЕНА ЯЗЫКА === -->
        <script type="module">
            (async () => {
                const translations = await fetch("translations.json")
                    .then((r) => r.json())
                    .catch((e) => {
                        console.error("Failed to load translations:", e);
                        return {
                            ru: "Харе Кришна Харе Кришна Кришна Кришна Харе Харе Харе Рама Харе Рама Рама Рама Харе Харе",
                        };
                    });
                const sel = document.getElementById("langSel");
                function render(lang = "ru") {
                    const txt = translations[lang] || translations.ru;
                    const words = txt.split(/\s+/).filter(Boolean);
                    const html = words
                        .map(
                            (w, i) =>
                                `<span style="--i:${(i % 16) + 1}">${w}</span>${i % 4 === 3 && i !== 15 ? "<br>" : ""}`,
                        )
                        .join("");
                    waviy.innerHTML = html;
                    attachFirstListener();
                    console.log("Rendered language:", lang);
                }
                render("ru");
                sel.addEventListener("change", (e) => render(e.target.value));
            })();
        </script>
    </body>
</html>
